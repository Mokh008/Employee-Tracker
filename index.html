<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>تسجيل حضور الموظفين</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background-color: #f0f2f5;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
    }
    .card {
        background-color: white;
        padding: 30px 40px;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        text-align: center;
        width: 320px;
    }
    .card h2 {
        margin-bottom: 25px;
        color: #333;
    }
    input[type="text"] {
        padding: 10px;
        width: 100%;
        margin-bottom: 20px;
        border-radius: 8px;
        border: 1px solid #ccc;
        box-sizing: border-box;
    }
    button {
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 8px;
        background-color: #007bff;
        color: white;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: 0.3s;
    }
    button:hover {
        background-color: #0056b3;
    }
    #status {
        margin-top: 20px;
        font-weight: bold;
        color: green;
        white-space: pre-line;
    }
</style>
</head>
<body>

<div class="card">
    <h2>تسجيل حضور الموظفين</h2>
    <input id="empId" type="text" placeholder="ادخل رقم ID">
    <button onclick="sendLocation()">احصل على موقعى الحالى</button>
    <p id="status"></p>
</div>

<script>
// ================= Device Info =================
function getDeviceInfo(empId) {

    // الحالة الافتراضية دايمًا Mobile
    var finalStatus = "Mobile";

    // Device ID ثابت للجهاز
    var deviceId = localStorage.getItem("device_id");
    if (!deviceId) {
        deviceId = "DEV-" + Math.random().toString(36).substr(2, 10);
        localStorage.setItem("device_id", deviceId);
    }

    // عدد مرات التسجيل
    var count = localStorage.getItem("device_changes_count");
    count = count ? parseInt(count) + 1 : 1;
    localStorage.setItem("device_changes_count", count);

    // كشف تغيير الجهاز لنفس الـ ID
    var lastDeviceKey = "last_device_for_" + empId;
    var lastDevice = localStorage.getItem(lastDeviceKey);

    if (lastDevice && lastDevice !== deviceId) {
        finalStatus = "Multiple device changes detected";
    }

    localStorage.setItem(lastDeviceKey, deviceId);

    return {
        device_id: deviceId,
        device_status: finalStatus,
        device_changes_count: count
    };
}
// ===============================================

function sendLocation() {
    var id = document.getElementById("empId").value;
    if (!id) {
        document.getElementById("status").innerText = "من فضلك أدخل رقم ID";
        return;
    }

    if (!navigator.geolocation) {
        alert("المتصفح لا يدعم تحديد الموقع.");
        return;
    }

    navigator.geolocation.getCurrentPosition(success, error, {
        enableHighAccuracy: true,
        timeout: 5000,
        maximumAge: 0
    });

    function success(pos) {
        var lat = pos.coords.latitude;
        var lng = pos.coords.longitude;

        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=ar`)
        .then(res => res.json())
        .then(data => {

            var addr = data.address || {};

            var village  = addr.village || addr.hamlet || addr.town || addr.city || "غير معروف";
            var district = addr.county || addr.suburb || addr.municipality || "غير معروف";
            var state    = addr.state || addr.region || "غير معروف";

            if (state === "المنيا") {
                if (lat > 27.6 && lat < 28.4 && lng > 30.6 && lng < 30.95) {
                    district = "ملوى";
                    if (village === "غير معروف") village = "ملوى";
                }
            }

            var location = village + " – " + district + " – " + state;
            var deviceInfo = getDeviceInfo(id);

            fetch("https://script.google.com/macros/s/AKfycbwTNwsFCzWKoBqyHlRPTtj3DdclIY3yz5XBKgBxAGbUALmH1nTpzka3UQrNankh5TE7ow/exec", {
                method: "POST",
                mode: "no-cors",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: new URLSearchParams({
                    id: id,
                    location: location,
                    lat: lat,
                    lng: lng,
                    location_link: "https://www.google.com/maps?q=" + lat + "," + lng,
                    device_id: deviceInfo.device_id,
                    device_status: deviceInfo.device_status,
                    device_changes_count: deviceInfo.device_changes_count
                })
            });

            var now = new Date();
            document.getElementById("status").innerText =
                "تم تسجيل الموقع بنجاح ✔\n" +
                location + "\n" +
                now.toLocaleString("ar-EG");
        });
    }

    function error() {
        alert("تعذر الحصول على الموقع.");
    }
}
</script>

</body>
</html>
