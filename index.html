<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>تسجيل حضور الموظفين</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
    font-family: Arial, sans-serif;
    background-color: #f0f2f5;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    margin: 0;
}
.card {
    background-color: white;
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    text-align: center;
    width: 90%;
    max-width: 350px;
}
input {
    padding: 12px;
    width: 100%;
    margin-bottom: 15px;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-size: 16px;
}
button {
    width: 100%;
    padding: 14px;
    border: none;
    border-radius: 8px;
    background-color: #007bff;
    color: white;
    font-size: 17px;
    font-weight: bold;
}
#status {
    margin-top: 15px;
    font-weight: bold;
    white-space: pre-line;
}
</style>
</head>

<body>

<div class="card">
    <h3>تسجيل الحضور</h3>
    <input id="empId" type="text" placeholder="ادخل رقم ID">
    <button onclick="sendLocation()">تسجيل</button>
    <div id="status"></div>
</div>

<script>
/* ===== Canvas Fingerprint ===== */
async function getDeviceID() {

    var canvas = document.createElement("canvas");
    var ctx = canvas.getContext("2d");

    ctx.textBaseline = "top";
    ctx.font = "16px Arial";
    ctx.fillStyle = "#f60";
    ctx.fillRect(120, 1, 60, 20);

    ctx.fillStyle = "#069";
    ctx.fillText("Fingerprint", 2, 15);

    ctx.strokeStyle = "rgba(102,204,0,0.7)";
    ctx.strokeText("Fingerprint", 4, 17);

    var data = canvas.toDataURL();

    var extra =
        navigator.userAgent +
        screen.width +
        screen.height +
        Intl.DateTimeFormat().resolvedOptions().timeZone;

    var enc = new TextEncoder();
    var hashBuffer = await crypto.subtle.digest(
        "SHA-256",
        enc.encode(data + extra)
    );

    return Array.from(new Uint8Array(hashBuffer))
        .map(b => b.toString(16).padStart(2, "0"))
        .join("");
}

/* ===== Main ===== */
async function sendLocation() {

    var id = document.getElementById("empId").value;
    if (!id) {
        document.getElementById("status").innerText = "ادخل رقم ID";
        return;
    }

    document.getElementById("status").innerText = "جارى التسجيل...";

    var device_id = await getDeviceID();

    navigator.geolocation.getCurrentPosition(async function (pos) {

        var lat = pos.coords.latitude;
        var lng = pos.coords.longitude;

        var location_link =
            "https://www.google.com/maps?q=" + lat + "," + lng;

        fetch(
          "https://script.google.com/macros/s/AKfycbxLF_UW55LMexCCN_-vCdhi0OfnT85En2tEC-YL9YK-vPjwZuz9Fk7rpF2x3QF9z6L1yw/exec",
          {
            method: "POST",
            body: new URLSearchParams({
                id: id,
                location: "From GPS",
                lat: lat,
                lng: lng,
                location_link: location_link,
                device_id: device_id
            })
          }
        )
        .then(() => {
            document.getElementById("status").innerText =
                "✔ تم التسجيل بنجاح";
        });

    }, function () {
        alert("فشل تحديد الموقع");
    }, {
        enableHighAccuracy: true,
        timeout: 5000
    });
}
</script>

</body>
</html>
