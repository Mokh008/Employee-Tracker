<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background-color: #f0f2f5;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
    }
    .card {
        background-color: white;
        padding: 30px 40px;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        text-align: center;
        width: 320px;
    }
    .card h2 {
        margin-bottom: 25px;
        color: #333;
    }
    input[type="text"] {
        padding: 10px;
        width: 100%;
        margin-bottom: 20px;
        border-radius: 8px;
        border: 1px solid #ccc;
        box-sizing: border-box;
    }
    button {
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 8px;
        background-color: #007bff;
        color: white;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: 0.3s;
    }
    button:hover {
        background-color: #0056b3;
    }
    #status {
        margin-top: 20px;
        font-weight: bold;
        color: green;
        white-space: pre-line;
    }
</style>
</head>
<body>

<div class="card">
    <h2>ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h2>
    <input id="empId" type="text" placeholder="Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù… ID">
    <button onclick="sendLocation()">Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹Ù‰ Ø§Ù„Ø­Ø§Ù„Ù‰</button>
    <p id="status"></p>
</div>

<script>
// Ø¨ØµÙ…Ø© Ø§Ù„Ø¬Ù‡Ø§Ø² (Ù…Ù† ØºÙŠØ± Ù…Ø§ Ù†Ø¨ÙˆØ¸ Ø£ÙŠ Ø­Ø§Ø¬Ø©)
function getDeviceId() {
    return btoa(
        navigator.userAgent +
        screen.width +
        screen.height +
        navigator.language
    );
}

function sendLocation() {
    var id = document.getElementById("empId").value;
    if (!id) {
        document.getElementById("status").innerText = "Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… ID";
        return;
    }

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(success, error, {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 0
        });
    } else {
        alert("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.");
    }

    function success(pos) {
        var lat = pos.coords.latitude;
        var lng = pos.coords.longitude;

        // ğŸ”¹ Ù†ÙØ³ Ø¢Ù„ÙŠØ© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù‚Ø±ÙŠØ© / Ø§Ù„Ù…Ø±ÙƒØ² / Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© (Ù…Ù† ØºÙŠØ± Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„)
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=ar`)
        .then(response => response.json())
        .then(data => {
            var addr = data.address;

            var village = addr.village || addr.hamlet || addr.town || addr.city || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
            var district = addr.county || addr.suburb || addr.municipality || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
            var state = addr.state || addr.region || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";

            if (state === "Ø§Ù„Ù…Ù†ÙŠØ§") {
                if (lat > 27.6 && lat < 28.4 && lng > 30.6 && lng < 30.95) {
                    district = "Ù…Ù„ÙˆÙ‰";
                    if (village === "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ" || village.includes("Ù‚Ø³Ù…") || village.includes("ØºÙŠØ±")) {
                        village = "Ù…Ù„ÙˆÙ‰";
                    }
                }
            }

            var location = village + " â€“ " + district + " â€“ " + state;

            // ğŸ”¹ Ø¬Ù„Ø¨ Ø§Ù„Ù€ IP
            fetch("https://api.ipify.org?format=json")
            .then(res => res.json())
            .then(ipData => {

                var deviceId = getDeviceId();
                var ip = ipData.ip;

                // ğŸ”¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ù€ URL Ø§Ù„Ø¬Ø¯ÙŠØ¯
                fetch("https://script.google.com/macros/s/AKfycbwNd3X39-4xx3h6GL2TsDMUl0ow4euvboatrsUTKI_oqueb_oorC5Vn1EEPEkctkpJqvw/exec", {
                    method: "POST",
                    body: new URLSearchParams({
                        "id": id,
                        "location": location,
                        "lat": lat,
                        "lng": lng,
                        "location_link": "https://www.google.com/maps?q=" + lat + "," + lng,
                        "ip": ip,
                        "device_id": deviceId
                    })
                });

                var now = new Date();
                var date = now.getFullYear() + "-" +
                           (now.getMonth()+1).toString().padStart(2,"0") + "-" +
                           now.getDate().toString().padStart(2,"0");
                var time = now.getHours().toString().padStart(2,"0") + ":" +
                           now.getMinutes().toString().padStart(2,"0") + ":" +
                           now.getSeconds().toString().padStart(2,"0");

                document.getElementById("status").innerText =
                    "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ù†Ø¬Ø§Ø­ âœ”\n" +
                    location + "\n" +
                    date + " " + time;
            });
        });
    }

    function error() {
        alert("ØªØ¹Ø°Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹.");
    }
}
</script>

</body>
</html>
