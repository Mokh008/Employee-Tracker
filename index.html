<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</title>

<style>
body {
    font-family: Arial, sans-serif;
    background-color: #f0f2f5;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    margin: 0;
}
.card {
    background-color: white;
    padding: 30px 40px;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    text-align: center;
    width: 320px;
}
.card h2 {
    margin-bottom: 25px;
    color: #333;
}
input[type="text"] {
    padding: 10px;
    width: 100%;
    margin-bottom: 20px;
    border-radius: 8px;
    border: 1px solid #ccc;
    box-sizing: border-box;
}
button {
    width: 100%;
    padding: 12px;
    border: none;
    border-radius: 8px;
    background-color: #007bff;
    color: white;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
}
button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}
.out-btn {
    background-color: #dc3545;
}
#status {
    margin-top: 15px;
    font-weight: bold;
    white-space: pre-line;
}
#loader {
    display: none;
    margin-top: 15px;
    font-weight: bold;
    color: #555;
}
</style>
</head>

<body>

<div class="card">
    <h2>ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h2>

    <input id="empId" type="text" placeholder="Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù… ID">

    <button id="inBtn" onclick="sendLocation('IN')">Ø¨ØµÙ…Ø© Ø¯Ø®ÙˆÙ„ â°</button>
    <br><br>
    <button id="outBtn" class="out-btn" onclick="sendLocation('OUT')">Ø¨ØµÙ…Ø© Ø®Ø±ÙˆØ¬ ğŸšª</button>

    <p id="status"></p>
    <div id="loader">â³ Ø¨Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±â€¦ Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨ØµÙ…Ø©</div>
</div>

<script>
function sendLocation(action) {

    var id = document.getElementById("empId").value;
    var statusEl = document.getElementById("status");
    var loader = document.getElementById("loader");
    var inBtn = document.getElementById("inBtn");
    var outBtn = document.getElementById("outBtn");

    if (!id) {
        statusEl.style.color = "red";
        statusEl.innerText = "âš ï¸ Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… ID";
        return;
    }

    // Ù‚ÙÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± + Loader
    inBtn.disabled = true;
    outBtn.disabled = true;
    loader.style.display = "block";
    statusEl.innerText = "";

    if (!navigator.geolocation) {
        alert("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.");
        loader.style.display = "none";
        inBtn.disabled = false;
        outBtn.disabled = false;
        return;
    }

    navigator.geolocation.getCurrentPosition(success, error, {
        enableHighAccuracy: true,
        timeout: 5000,
        maximumAge: 0
    });

    function success(pos) {
        var lat = pos.coords.latitude;
        var lng = pos.coords.longitude;

        // Ø¨ØµÙ…Ø© Ø§Ù„Ø¬Ù‡Ø§Ø²
        var deviceId =
            navigator.userAgent +
            navigator.language +
            screen.width + "x" + screen.height +
            navigator.platform;

        // 1ï¸âƒ£ Ø¬Ù„Ø¨ IP
        fetch("https://api.ipify.org?format=json")
        .then(res => res.json())
        .then(ipData => {

            // 2ï¸âƒ£ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ù„Ø¹Ù†ÙˆØ§Ù† Ø¹Ø±Ø¨ÙŠ
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=ar`)
            .then(res => res.json())
            .then(data => {

                var addr = data.address || {};
                var village = addr.village || addr.hamlet || addr.town || addr.city || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
                var district =
                    addr.municipality ||
                    addr.county ||
                    addr.city_district ||
                    addr.suburb ||
                    addr.city ||
                    "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
                var state = addr.state || addr.region || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";

                var location = village + " â€“ " + district + " â€“ " + state;

                // 3ï¸âƒ£ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Google Sheet
                fetch("https://script.google.com/macros/s/AKfycbywD2-cRxoGWYbv0Ih5RCTuDccoDHD2QO5LTSK1g_r6MTFqZ98IQ53xrZAn48tVF-zr6g/exec", {
                    method: "POST",
                    body: new URLSearchParams({
                        id: id,
                        location: location,
                        lat: lat,
                        lng: lng,
                        location_link: "https://www.google.com/maps?q=" + lat + "," + lng,
                        device_id: deviceId,
                        ip: ipData.ip,
                        action: action
                    })
                })
                .then(res => res.text())
                .then(result => {

                    loader.style.display = "none";
                    inBtn.disabled = false;
                    outBtn.disabled = false;

                    // âŒ Ø£Ø®Ø·Ø§Ø¡
                    if (result.startsWith("ERROR")) {
                        statusEl.style.color = "red";

                        if (result.includes("OUT")) {
                            statusEl.innerText =
                              "âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù‚Ø¨Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„";
                        } else if (result.includes("IN")) {
                            statusEl.innerText =
                              "âš ï¸ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„ÙØ¹Ù„ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† ØªØ³Ø¬ÙŠÙ„Ù‡ Ù…Ø±ØªÙŠÙ†";
                        } else {
                            statusEl.innerText = "âš ï¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­Ø©";
                        }
                        return;
                    }

                    // âœ… Ù†Ø¬Ø§Ø­
                    statusEl.style.color = "green";

                    // Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…ØµØ­Ù‘Ø­ Ù…Ù† Google Sheet
                    var parts = result.split("|");
                    var finalLocation = parts.length > 1 ? parts[1] : location;

                    var now = new Date();
                    var date =
                        now.getFullYear() + "-" +
                        (now.getMonth()+1).toString().padStart(2,"0") + "-" +
                        now.getDate().toString().padStart(2,"0");

                    var time =
                        now.getHours().toString().padStart(2,"0") + ":" +
                        now.getMinutes().toString().padStart(2,"0") + ":" +
                        now.getSeconds().toString().padStart(2,"0");

                    statusEl.innerText =
                        "âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨ØµÙ…Ø© Ø¨Ù†Ø¬Ø§Ø­\n" +
                        finalLocation + "\n" +
                        date + " " + time;
                });
            });
        });
    }

    function error() {
        loader.style.display = "none";
        inBtn.disabled = false;
        outBtn.disabled = false;
        alert("ØªØ¹Ø°Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹.");
    }
}
</script>

</body>
</html>


