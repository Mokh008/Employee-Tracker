<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</title>
<style>
/* Ù†ÙØ³ Ø§Ù„Ø³ØªØ§ÙŠÙ„ */
body {
    font-family: Arial, sans-serif;
    background-color: #f0f2f5;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    margin: 0;
}
.card {
    background-color: white;
    padding: 30px 40px;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    text-align: center;
    width: 320px;
}
</style>
</head>
<body>

<div class="card">
<h2>ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h2>
<input id="empId" type="text" placeholder="Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù… ID">
<button onclick="sendLocation()">Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹Ù‰ Ø§Ù„Ø­Ø§Ù„Ù‰</button>
<p id="status"></p>
</div>

<script>
// =====================
// Device Fingerprint
// =====================
function getDeviceId() {
    return btoa(
        navigator.userAgent +
        screen.width +
        screen.height +
        navigator.language
    );
}

// =====================
// ØªØ­Ø¯ÙŠØ¯ Ù…Ø±Ø§ÙƒØ² Ø§Ù„Ù…Ù†ÙŠØ§ Ø¨Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª
// =====================
function getMinyaDistrict(lat, lng) {

    if (lat > 27.85 && lat < 28.05 && lng > 30.75 && lng < 31.00) {
        return "Ø£Ø¨Ùˆ Ù‚Ø±Ù‚Ø§Øµ";
    }

    if (lat > 27.60 && lat < 27.85 && lng > 30.60 && lng < 30.95) {
        return "Ù…Ù„ÙˆÙ‰";
    }

    if (lat > 28.00 && lat < 28.20 && lng > 30.70 && lng < 31.00) {
        return "Ø§Ù„Ù…Ù†ÙŠØ§";
    }

    if (lat > 28.20 && lat < 28.60) {
        return "Ø³Ù…Ø§Ù„ÙˆØ·";
    }

    return null;
}

function sendLocation() {

    var id = document.getElementById("empId").value;
    if (!id) return alert("Ø§Ø¯Ø®Ù„ ID");

    navigator.geolocation.getCurrentPosition(function(pos){

        var lat = pos.coords.latitude;
        var lng = pos.coords.longitude;

        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=ar`)
        .then(res => res.json())
        .then(data => {

            var addr = data.address;

            // Ø§Ù„Ù‚Ø±ÙŠØ© (Ø²ÙŠ Ù…Ø§ Ù‡ÙŠ)
            var village = addr.village || addr.hamlet || addr.town || addr.city || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";

            var state = addr.state || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";

            var district = "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";

            // ğŸ”¥ ÙØ±Ø¶ Ø§Ù„Ù…Ø±ÙƒØ² Ù…Ù† Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª
            if (state === "Ø§Ù„Ù…Ù†ÙŠØ§") {
                district = getMinyaDistrict(lat, lng) || district;
            }

            var location = village + " â€“ " + district + " â€“ " + state;

            fetch("https://api.ipify.org?format=json")
            .then(res => res.json())
            .then(ipData => {

                fetch("https://script.google.com/macros/s/AKfycbwNd3X39-4xx3h6GL2TsDMUl0ow4euvboatrsUTKI_oqueb_oorC5Vn1EEPEkctkpJqvw/exec", {
                    method: "POST",
                    body: new URLSearchParams({
                        id,
                        location,
                        lat,
                        lng,
                        location_link: `https://www.google.com/maps?q=${lat},${lng}`,
                        ip: ipData.ip,
                        device_id: getDeviceId()
                    })
                });

                document.getElementById("status").innerText =
                    "ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ âœ”\n" + location;
            });
        });
    });
}
</script>

</body>
</html>
